{% extends 'base_kr.html' %}
{% block content %}
    {% load static %}
    <div id="rootDiv">
        <div id="width_workout_table">
            <header id="titleHeader" class="w3-container w3-xlarge" style="margin-bottom: 24px;">
                <h2 class="w3-left"><span>안녕하세요, </span><span style="color: #5F36C4;">{{ name }}</span></h2>
            </header>
            <div class="sub_content">
                <!-- head -->
                <div id="liftCreatorHeader">
                    <div id="workoutTitleDivParent">
                        <span id="workoutDate">{% now "Y. m. d" %} {% now "D" %}</span>
                        <div id="workoutTitleDiv">
                            <input id="workoutTitle" type="text" placeholder="예 : 내 운동" value="">
                            <img onclick="$('#workoutTitle').val('');" src="{% static 'close.svg' %}" width="14px" height="14px" style="cursor: pointer; margin: 0; padding: 0;">
                        </div>
                    </div>
                    <div id="liftCreatorHead">
                        <a></a>
                        <span id="exerciseDurationDisplay" style="font-size: xx-large; color: #5F36C4;">{% now "G:i:s" %}</span>
                        <input id="exerciseDuration" type="number" name="exerciseDuration" value="0" hidden>
                        <div style="display: inline-block;" id="stopwatchControls">
                            <a onclick="stopwatchControlButtonClick();" class="stopwatchControlButton darkBlueBackground"><img id="timerControlButton" src="{% static 'play.png' %}" height="16px"></a>
                            <a onclick="stopwatchResetClick();" class="stopwatchControlButton grayBackground" style="display: none" id="timerResetButton"><img src="{% static 'stop.png' %}" height="16px"></a>
                        </div>
                    </div>
                </div>
                <!-- body -->
                <div id="liftCreatorBody">
                    <div id="loadFavoriteWorkoutDiv" style="display: inline-block; font-size: small; margin-bottom: 8px;">
                        <a href="{% url 'favorite workouts' %}" id="favorite_workouts_button" style="padding: 5px 16px;">운동세트 불러오기</a>
                    </div>
                    <table id="newExercisesTable">
                        <tr>
                            <th class="arrow_column"></th>
                            <th class="set_column">No.</th>
                            <th class="exercise_column">운동</th>
                            <th class="weight_column" id="weight_th" style="cursor: pointer;">KG</th>
                            <th class="repetition_column">REP</th>
                            <th class="rm_column">RM</th>
                            <th class="done_column"></th>
                        </tr>
                        <tr style="color: #777">
                            <td class="arrow_column"></td>
                            <td class="set_column light-grey-text"></td>
                            <td class="exercise_column" id="selectedExerciseName"
                                onclick="showExerciseSelectorDivClick();">{{ exercises.0.name }} ({{ exercises.0.body_part.name }})
                            </td>
                            <td class="weight_column"><input id="newLiftWeight" class="newLiftWeight" type="number" min="1"
                                                             max="200" placeholder="1"
                                                             value="1"></td>
                            <td class="repetition_column"><input id="newLiftReps" class="newLiftReps" type="number" min="1"
                                                                 max="30" placeholder="1"
                                                                 value="1"></td>
                            <td class="rm_column" id="newRmMax"></td>
                            <td class="done_column">
                                <button onclick="addNewLift();" class="grayBackground" style="padding: 8px; margin: 0; line-height: 1; border-radius: 16px; border: none; cursor: pointer;">
                                    <img id="timerControlButton" src="{% static 'add.png' %}" height="16px"></button>
                            </td>
                        </tr>
                    </table>
                </div>
                <!-- tail -->
                <div id="liftCreatorFooter">
                    <a id="fullResetButton" onclick="fullResetClick()" class="grayBackground" style="color: white; padding: 4px 52px; border-radius: 16px; display: inline-block; cursor: pointer">취소</a>
                    <a id="removeExercisesButton" onclick="clearExercises()" class="grayBackground" style="color: white; padding: 4px 52px; border-radius: 16px; display: inline-block; cursor: pointer">삭제</a>
                    <a id="saveExerciseButton" onclick="saveExercises()" class="darkBlueBackground" style="color: white; padding: 4px 52px; border-radius: 16px; display: inline-block; margin-left: 16px; cursor: pointer">저장</a>
                </div>
            </div>
        </div>
        <div id="width_workout_card">
            <div id="today_workouts"></div>
        </div>
    </div>

    <style>
        #workoutTitle, .newLiftWeight, .newLiftReps, #newRmMax {
            font-size: 14px;
            font-weight: lighter;
            background: #0000;
            outline: none;
            box-sizing: border-box;
            border: none;
        }

        @media (min-width: 801px) {
            #rootDiv {
                margin: 0;
                padding: 0;
                display: flex;
                justify-content: space-between;
            }

            #calculatorSwitchTabs {
                display: flex;
            }

            #width_workout_table {
                width: calc(65% - 10px);
                margin: 0px;
                padding: 0px;
                display: inline-block;
            }

            #width_workout_card {
                width: calc(35% - 10px);
                margin: 0;
                padding: 0;
                display: inline-block;
            }

            #workoutTitleDiv a:first-child {
                display: inline-block;
            }

            #workoutTitleDiv {
                display: inline-flex;
                flex-grow: 1;
                justify-content: space-between;
                align-items: center;
            }

            #liftCreatorHead {
                display: flex;
                flex-grow: 1;
                justify-content: space-between;
                align-items: center;
            }

            #workoutDate {
                display: inline-block;
                font-size: small;
                text-align: start;
                max-width: 128px;
                color: darkgray;
            }

            #workoutTitleDivParent {
                display: inline-block;
                width: 160px;
            }

            #workoutTitle {
                width: 128px;
                border-bottom: 1px solid #5F36C4;
                font-size: 17px;
            }

            #liftCreatorFooter {
                text-align: right;
            }
        }

        @media (max-width: 800px) {
            .w3-main {
                padding: 0;
            }

            #calculatorSwitchTabs {
                display: block;
            }

            #width_workout_table .sub_content {
                border-radius: 0;
                margin: 0;
                padding: 0 0 24px;
            }

            #calculatorSwitchTabs {
                padding-top: 24px;
                padding-left: 24px;
                padding-right: 24px;
            }

            #titleHeader {
                padding: 32px 32px 0;
            }

            #workoutTitleDiv {
                display: flex;
                align-items: center;
                justify-content: space-evenly;
            }

            #workoutTitleDiv a:first-child {
                display: none;
            }

            #workoutTitleDivParent {
                display: block;
            }

            #liftCreatorHead {
                margin-top: 16px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            #liftCreatorHead div:first-child {
                display: block;
            }

            #workoutDate {
                display: block;
                font-size: small;
                text-align: start;
                color: darkgray;
            }

            #workoutTitle {
                width: calc(100% - 12px);
                display: block;
                border-bottom: 1px solid #5F36C4;
                font-size: 17px;
            }

            #loadFavoriteWorkoutDiv a {
                margin-left: 24px;
            }

            #today_workouts {
                padding: 24px;
            }

            #liftCreatorHeader {
                padding: 12px;
            }

            #liftCreatorFooter {
                display: flex;
                justify-content: space-between;
                padding: 0 24px;
            }
        }

        #liftCreatorFooter {
            height: 30px;
            margin-top: 50px;
        }

        #liftCreatorBody {
            margin-top: 50px;
        }

        .stopwatchControlButton {
            display: inline-block;
            width: 40px;
            height: 40px;
            padding: 8px;
            cursor: pointer;
            text-align: center;
            border-radius: 20px;
        }

        .darkBlueBackground {
            background-color: #5F36C4;
        }

        .grayBackground {
            background-color: darkgray;
        }

        .stopwatchControlButton img {
            padding: 0;
            margin: 0;
        }

        #workoutTitle::placeholder {
            color: #C5BDEC;
        }

        /* region tables */
        table {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
            table-layout: fixed;
        }

        .arrow_column {
            width: 5%;
        }

        .set_column {
            width: 8%;
        }

        .exercise_column {
            width: 40%;
        }

        .weight_column {
            width: 10%
        }

        .rm_column {
            width: 10%
        }

        .repetition_column {
            width: 15%
        }

        .done_column {
            width: 12%
        }


        td, th {
            border: 1px solid transparent; /* No more visible border */
            height: 30px;
        }

        th {
            color: white;
            font-size: small;
        }

        td {
            background: white;
            text-align: center;
            cursor: pointer;
            padding: 5px;
            font-size: small;
        }

        .light-grey-text {
            color: lightgrey;
        }

        .dark-blue-text {
            color: #5F36C4;
        }

        .light-blue-text {
            color: #C5BDEC;
        }

        tr:first-child th {
            background-color: #E6DFF5;
            color: #5F36C4;
            font-weight: normal;
        }

        tr:first-child th:first-child {
            border-bottom-left-radius: 16px;
            border-top-left-radius: 16px;
        }

        tr:first-child th:last-child {
            border-bottom-right-radius: 16px;
            border-top-right-radius: 16px;
        }

        tr:not(:first-child) {
            border-bottom: 1.5px solid #bbb;
        }

        tr td:nth-child(3), tr th:nth-child(3) {
            text-align: start;
        }

        #newExercisesTable input {
            text-align: center;
        }

        /* endregion */

        #favorite_workouts_button {
            margin: 3px;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 16px;
            text-decoration: none;
            background-color: #5F36C4;
            color: white;
            transition-duration: 200ms;
        }

        #favorite_workouts_button:hover {
            background-color: #DDDDDD;
            color: black;
            transition-duration: 200ms;
        }

        @media (max-width: 400px) {
            .arrow_column {
                display: none;
            }

            .set_column {
                display: none;
            }

            .exercise_column {
                width: 35%;
            }

            .weight_column {
                width: 15%
            }

            .repetition_column {
                width: 15%
            }

            .rm_column {
                width: 15%
            }

            .done_column {
                width: 15%
            }

            tr td:nth-child(3), tr th:nth-child(3) {
                text-align: start;
                padding-left: 4px;
            }
        }
    </style>
    <script>
        const weekdayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
        const KG2LBS = 2.20462262185;
        const ONE_REP_MAX_CONST = 0.025;

        let selectExerciseDiv, exercisesListDiv, filterExerciseCategory;
        let allExercises = [{% for exercise in exercises %}{
                id: {{ exercise.id }},
                name: '{{ exercise.name }}',
                nameTranslations: {{ exercise.name_translations|safe }},
                iconUrl: '{{ exercise.icon.url }}',
                bodyPart: '{{ exercise.body_part.name }}',
                category: '{{ exercise.category.name }}'},{% endfor %}];
        let selectedExercise = {
            id: {{ exercises.0.id }},
            name: '{{ exercises.0.name }}',
            nameTranslations: {{ exercises.0.name_translations|safe }},
            iconUrl: '{{ exercises.0.icon.url }}',
            bodyPart: '{{ exercises.0.body_part.name }}',
            category: '{{ exercises.0.category.name }}'
        };
        let stopwatchId, stopwatchSeconds = 0;

        function findExerciseByName(name) {
            for (let i = 0; i < allExercises.length; i++)
                if (allExercises[i].name === name)
                    return allExercises[i];
            return null;
        }

        let editWorkout = null;
        let newLifts = [];
        let newSetNumber = 1, newLift = "{{ exercises.0.name }}", newWeight = 1, newReps = 1;

        {% load tools %}
        let allWorkouts = [
            {% for day_str, workout_sessions in workouts_by_days.items %}
                {% for workout_session, lifts in workout_sessions.items %}
                    {
                        id: {{ workout_session.id }},
                        title: "{{ workout_session.title }}",
                        dayStr: "{{ day_str }}",
                        duration: {{ workout_session.duration }},
                        lifts: [{% for lift in lifts %}{id: {{ lift.id }}, exerciseName: "{{ lift.exercise.name }}", liftMass: {{ lift.lift_mass }}, repetitions: {{ lift.repetitions }}, rmMax: {{ lift.one_rep_max }}}{% if not forloop.last %}, {% endif %}{% endfor %}]
                    },
                {% endfor %}
            {% endfor %}];

        $(document).ready(function () {
            $('#fullResetButton').hide();

            $(".default_option").click(function () {
                $(".dropdown ul").addClass("active");
            });

            $(".dropdown ul li").click(function () {
                $(".default_option").text($(this).text());
                $(".dropdown ul").removeClass("active");
            });

            $('#weight_th').click(function () {
                // switch KG / LBS
                let el = $('#weight_th');
                el.html(el.html().toLowerCase() === 'kg' ? 'LBS' : 'KG');

                // region inserted exercise rows
                setNewLiftsOnUI(newLifts);
                // endregion
                // region new exercise row
                let newLiftWeight = $('#newLiftWeight');
                let newRmMax = $('#newRmMax');
                newLiftWeight.prop('disabled', true);
                newRmMax.prop('disabled', true);
                if (el.html().toLowerCase() === 'kg') {
                    let rmMax = Math.trunc((newWeight + newWeight * newReps * ONE_REP_MAX_CONST) * 100) / 100;
                    $('#newLiftWeight').val(newWeight);
                    $('#newRmMax').html(rmMax);
                } else {
                    let massLbs = Math.trunc(newWeight * 2.2 * 10) / 10;
                    let rmMaxLbs = Math.trunc((newWeight * KG2LBS + newWeight * KG2LBS * newReps * ONE_REP_MAX_CONST) * 100) / 100;
                    $('#newLiftWeight').val(massLbs);
                    $('#newRmMax').html(rmMaxLbs);
                }
                newLiftWeight.prop('disabled', false);
                newRmMax.prop('disabled', false);
                // endregion

                // region workouts
                let fromTs = new Date();
                fromTs.setHours(0);
                fromTs.setMinutes(0);
                fromTs.setSeconds(0);
                fromTs.setMilliseconds(0);
                let tillTs = new Date(fromTs);
                tillTs.setDate(fromTs.getDate() + 1);
                fetchTodayDayWorkouts(fromTs.getTime(), tillTs.getTime());
                // endregion
            });

            $('#exerciseDurationDisplay').html("00:00:00");

            selectExerciseDiv = document.getElementById('selectExerciseDivRoot');
            exercisesListDiv = document.getElementById('exercisesListDiv');

            let weight = parseInt($('#newLiftWeight').val());
            let reps = parseInt($('#newLiftReps').val());
            let rm = Math.trunc((weight + weight * reps * ONE_REP_MAX_CONST) * 100) / 100;
            $('#newRmMax').html(rm);

            $('#newLiftWeight').change(function () {
                let kgMode = $('#weight_th').html().toLowerCase() === 'kg';
                newWeight = kgMode ? parseFloat($('#newLiftWeight').val()) : parseFloat($('#newLiftWeight').val()) * KG2LBS;
                if (kgMode)
                    $('#newRmMax').html(Math.trunc((newWeight + newWeight * newReps * ONE_REP_MAX_CONST) * 100) / 100);
                else
                    $('#newRmMax').html(Math.trunc((newWeight * KG2LBS + newWeight * KG2LBS * newReps * ONE_REP_MAX_CONST) * 100) / 100);
            });
            $('#newLiftReps').change(function () {
                let kgMode = $('#weight_th').html().toLowerCase() === 'kg';
                newReps = parseInt($('#newLiftReps').val());
                if (kgMode)
                    $('#newRmMax').html(Math.trunc((newWeight + newWeight * newReps * ONE_REP_MAX_CONST) * 100) / 100);
                else
                    $('#newRmMax').html(Math.trunc((newWeight * KG2LBS + newWeight * KG2LBS * newReps * ONE_REP_MAX_CONST) * 100) / 100);
            });

            // tabs communication
            window.addEventListener("storage", function (_) {
                let event = JSON.parse(localStorage.getItem('message'));
                if (event.action === 'workout') {
                    editWorkout = event.value;
                    if (editWorkout != null)
                        displayWorkoutForEditing(editWorkout);
                    else
                        clearWorkoutDetails();
                } else if (event.action === 'lifts') {
                    newLifts = event.value;
                    setNewLiftsOnUI(newLifts);
                } else if (event.action === 'stopwatchData') {
                    let stopwatchData = event.value;
                    $('#exerciseDurationDisplay').html(pad(stopwatchData.hours, 2) + ':' + pad(stopwatchData.minutes, 2) + ':' + pad(stopwatchData.seconds, 2));
                    $('#exerciseDuration').attr('value', stopwatchSeconds.toString());
                }
            });

            // recovers exercises from local storage (backupped when closing tab)
            let prevExercises = localStorage.getItem('exercises_backup');
            if (prevExercises != null) {
                newLifts = JSON.parse(prevExercises);
                setNewLiftsOnUI(newLifts);
            }
            let prevWorkout = localStorage.getItem('workout_backup');
            if (prevWorkout != null) {
                editWorkout = JSON.parse(prevWorkout);
                displayWorkoutForEditing(editWorkout);
            }

            let params = window.location.search.substr(1).split("&");
            let exercise;
            for (let i = 0; i < params.length; i++) {
                let kv = params[i].split('=');
                if (kv[0] === 'exerciseId')
                    for (let j = 0; j < allExercises.length; j++)
                        if (allExercises[j].id.toString() === kv[1]) {
                            exercise = allExercises[j];
                            break;
                        }
            }
            if (exercise != null) {
                $('#newLiftReps').val(1);
                selectExerciseClick(exercise.name);
            }

            let fromTs = new Date();
            fromTs.setHours(0);
            fromTs.setMinutes(0);
            fromTs.setSeconds(0);
            fromTs.setMilliseconds(0);
            let tillTs = new Date(fromTs);
            tillTs.setDate(fromTs.getDate() + 1);
            fetchTodayDayWorkouts(fromTs.getTime(), tillTs.getTime());
        });

        function setNewLiftsOnUI(lifts) {
            $("#newExercisesTable tr:not(:last-child, :first-child)").empty();

            for (let i = 0; i < lifts.length; i++) {
                let rmMaxLbs = Math.trunc((lifts[i].liftMass * KG2LBS + lifts[i].liftMass * KG2LBS * lifts[i].repetitions * ONE_REP_MAX_CONST) * 100) / 100;
                if (lifts[i].enabled) {
                    $('#newExercisesTable tr:last').before(
                        `<tr id="exerciseRow${i}">` +
                        `   <td class="arrow_column">${i === 0 ? '' : `<a onclick="shiftLiftUp(${i});">△</a>`}${i === 0 || i === lifts.length - 1 ? '' : '<br>'}${i === lifts.length - 1 ? '' : `<a onclick="shiftLiftDown(${i});">▽</a>`}</td>` +
                        `   <td onclick="copyExercise(${i});" class="set_column dark-blue-text">${i + 1}</td>` +
                        `   <td onclick="copyExercise(${i});" class="exercise_column dark-blue-text">${lifts[i].exercise.name} (${lifts[i].exercise.bodyPart})</td>` +
                        `   <td class="weight_column">` +
                        `       <input id="liftWeight${i}" class="newLiftWeight dark-blue-text" style="text-alight: center;" type="number" min="1" max="200" placeholder="1" value="${$('#weight_th').html().toLowerCase() === 'kg' ? lifts[i].liftMass : Math.trunc(lifts[i].liftMass * KG2LBS * 10) / 10}">` +
                        `   </td>` +
                        `   <td class="repetition_column dark-blue-text">` +
                        `       <input id="liftReps${i}" class="newLiftReps dark-blue-text" style="text-alight: center;" type="number" min="1" max="30" placeholder="1" value="${lifts[i].repetitions}">` +
                        `   </td>` +
                        `   <td id="rmMax${i}" class="rm_column dark-blue-text">${$('#weight_th').html().toLowerCase() === 'kg' ? lifts[i].rmMax : rmMaxLbs}</td>` +
                        `   <td class="done_column">` +
                        `       <button onclick="toggleExercise(${i});" class="darkBlueBackground" style="padding: 8px; margin: 0; line-height: 1; border-radius: 16px; border: none; cursor: pointer;">` +
                        `           <img id="timerControlButton" src="{% static 'checked.png' %}" height="16px">` +
                        `       </button>` +
                        `   </td>` +
                        `</tr>`
                    );
                    $(`#liftWeight${i}, #liftReps${i}`).change(function () {
                        let weight = parseInt($(`#liftWeight${i}`).val());
                        let reps = parseInt($(`#liftReps${i}`).val());

                        lifts[i].liftMass = weight;
                        lifts[i].repetitions = reps;
                        lifts[i].rmMax = Math.trunc((weight + weight * reps * ONE_REP_MAX_CONST) * 100) / 100;

                        message_broadcast({action: 'lifts', value: lifts});
                    });
                } else
                    $('#newExercisesTable tr:last').before(
                        `<tr id="exerciseRow${i}">` +
                        `   <td class="arrow_column">${i === 0 ? '' : `<a onclick="shiftLiftUp(${i});">△</a>`}${i === 0 || i === lifts.length - 1 ? '' : '<br>'}${i === lifts.length - 1 ? '' : `<a onclick="shiftLiftDown(${i});">▽</a>`}</td>` +
                        `   <td onclick="copyExercise(${i});" class="set_column light-grey-text">${i + 1}</td>` +
                        `	<td onclick="copyExercise(${i});" class="exercise_column light-grey-text">${lifts[i].exercise.name} (${lifts[i].exercise.bodyPart})</td>` +
                        `	<td class="weight_column light-grey-text">${$('#weight_th').html().toLowerCase() === 'kg' ? lifts[i].liftMass : Math.trunc(lifts[i].liftMass * KG2LBS * 10) / 10}</td>` +
                        `	<td class="repetition_column light-grey-text">${lifts[i].repetitions}</td>` +
                        `	<td class="rm_column light-grey-text">${$('#weight_th').html().toLowerCase() === 'kg' ? lifts[i].rmMax : rmMaxLbs}</td>` +
                        `	<td class="done_column">` +
                        `       <button onclick="toggleExercise(${i});" style="background-color: transparent; padding: 8px; margin: 0; line-height: 1; border-radius: 16px; border: none; cursor: pointer;">` +
                        `           <img id="timerControlButton" src="{% static 'unchecked.png' %}" height="16px">` +
                        `       </button>` +
                        `	</td>` +
                        `</tr>`
                    );
            }
        }

        function showExerciseSelectorDivClick() {
            if (document.readyState === "complete")
                selectExerciseDiv.style.display = 'block';
        }

        function hideExerciseSelectorDivClick() {
            selectExerciseDiv.style.display = 'none';
        }

        function selectExerciseClick(name) {
            let newExercise = null;
            let nameLower = name.toLowerCase();

            for (let i = 0; i < allExercises.length; i++)
                if (allExercises[i].name.toLowerCase() === nameLower) {
                    newExercise = allExercises[i];
                    break;
                }

            if (newExercise != null) {
                $('#selectedExerciseName').html(newExercise.name);
                $('#selectedBodyPart').html(newExercise.bodyPart);
                selectedExercise = newExercise;
                hideExerciseSelectorDivClick();
            }
        }

        function pad(num, size) {
            let s = "000000000" + num;
            return s.substr(s.length - size);
        }

        function stopwatchControlButtonClick() {
            if (stopwatchId == null) {
                $('#timerControlButton').attr('src', "{% static 'pause.png' %}");
                stopwatchId = setInterval(function () {
                    stopwatchSeconds++;
                    let seconds = stopwatchSeconds % 60;
                    let minutes = ((stopwatchSeconds - seconds) / 60) % 60;
                    let hours = (((stopwatchSeconds - seconds) / 60) - minutes) / 60;
                    $('#exerciseDurationDisplay').html(pad(hours, 2) + ':' + pad(minutes, 2) + ':' + pad(seconds, 2));
                    $('#exerciseDuration').attr('value', stopwatchSeconds.toString());

                    // broadcast to other tabs
                    message_broadcast({
                        action: 'stopwatchData', value: {
                            seconds: seconds,
                            minutes: minutes,
                            hours: hours
                        }
                    });
                }, 1000);
                $('#timerResetButton').show();
            } else {
                $('#timerControlButton').attr('src', "{% static 'play.png' %}");
                clearInterval(stopwatchId);
                stopwatchId = null;

                if (stopwatchSeconds === 0)
                    $('#timerResetButton').hide();
            }
        }

        function stopwatchResetClick() {
            clearInterval(stopwatchId);
            $('#exerciseDurationDisplay').html('00:00:00');
            $('#exerciseDuration').attr('value', 0);
            stopwatchSeconds = 0;
            $('#timerResetButton').hide();
            $('#timerControlButton').attr('src', "{% static 'play.png' %}");

            // broadcast to other tabs
            message_broadcast({
                action: 'stopwatchData', value: {
                    seconds: 0,
                    minutes: 0,
                    hours: 0
                }
            });
        }

        function addNewLift() {
            // add to array
            newLift = {
                id: newLifts.length + 1,
                exercise: selectedExercise,
                liftMass: newWeight,
                repetitions: newReps,
                enabled: true,
                rmMax: Math.trunc((newWeight + newWeight * newReps * ONE_REP_MAX_CONST) * 100) / 100
            };
            newLifts.push(newLift);

            // send as a broadcast to all tabs i.e. save locally
            message_broadcast({action: 'lifts', value: newLifts});
        }

        function addNewExerciseWithRawValues(liftMass, reps, exerciseName, rmMax) {
            rmMax = Math.trunc((liftMass + liftMass * reps * ONE_REP_MAX_CONST) * 100) / 100;
            // add to array
            newLift = {
                id: newLifts.length + 1,
                exercise: findExerciseByName(exerciseName),
                liftMass: liftMass,
                repetitions: reps,
                enabled: true,
                rmMax: rmMax
            };
            newLifts.push(newLift);

            // send as a broadcast to all tabs i.e. save locally
            message_broadcast({action: 'lifts', value: newLifts});
        }

        function toggleExercise(idx) {
            newLifts[idx].enabled = !newLifts[idx].enabled;
            message_broadcast({action: 'lifts', value: newLifts});
        }

        function copyExercise(idx) {
            $('#selectedExerciseName').html(newLifts[idx].exercise.name);
            $('#selectedBodyPart').html(newLifts[idx].exercise.bodyPart);
            selectedExercise = newLifts[idx].exercise;

            $('#newLiftWeight').val(newLifts[idx].liftMass);
            $('#newLiftReps').val(newLifts[idx].repetitions);
            $('#newRmMax').html(newLifts[idx].rmMax);
        }

        function shiftLiftUp(idx) {
            // swap lifts
            let temp = newLifts[idx];
            newLifts[idx] = newLifts[idx - 1];
            newLifts[idx - 1] = temp;

            // update UI
            message_broadcast({action: 'lifts', value: newLifts});
        }

        function shiftLiftDown(idx) {
            // swap lifts
            let temp = newLifts[idx];
            newLifts[idx] = newLifts[idx + 1];
            newLifts[idx + 1] = temp;

            // update UI
            message_broadcast({action: 'lifts', value: newLifts});
        }

        function repeatWorkoutSession(workoutSessionId) {
            for (let i = 0; i < allWorkouts.length; i++)
                if (allWorkouts[i].id === workoutSessionId) {
                    $("#workoutTitle").val(allWorkouts[i].title);
                    for (let j = 0; j < allWorkouts[i].lifts.length; j++)
                        addNewExerciseWithRawValues(allWorkouts[i].lifts[j].liftMass, allWorkouts[i].lifts[j].repetitions, allWorkouts[i].lifts[j].exerciseName);
                    break;
                }
        }

        function clearExercises() {
            for (let i = 0; i < newLifts.length; i++)
                if (newLifts[i].enabled) {
                    newLifts.splice(i, 1);
                    i--;
                }
            message_broadcast({action: 'lifts', value: newLifts});
        }

        function saveExercises() {
            // filter out disabled exercises
            let resLifts = [];
            for (let i = 0; i < newLifts.length; i++)
                if (newLifts[i].enabled)
                    resLifts.push({
                        exerciseName: newLifts[i].exercise.name,
                        liftMass: newLifts[i].liftMass,
                        repetitions: newLifts[i].repetitions,
                    });

            if (resLifts.length > 0) {
                let title = $("#workoutTitle").val();

                if (editWorkout == null)
                    $.post('{% url 'add workout' %}', {
                        csrfmiddlewaretoken: $('{% csrf_token %}').val(),
                        title: title === '' ? '[이름없는 운동]' : title,
                        duration: stopwatchSeconds,
                        exercises: JSON.stringify(resLifts)
                    }, function (response) {
                        try {
                            if (response.success) {
                                message_broadcast({action: 'lifts', value: []});
                                location.reload();
                            }
                        } catch (e) {
                            console.log(e);
                        }
                    });
                else {
                    let prevIds = new Set();
                    for (let i = 0; i < editWorkout.lifts.length; i++)
                        prevIds.add(editWorkout.lifts[i].id);

                    console.log(`Previous lifts : ${prevIds.size}`);
                    for (let i = 0; i < newLifts.length; i++) {
                        if (!newLifts[i].enabled)
                            // remove
                            $.post('/api/remove_lift', {sessionKey: "{{ sessionKey }}", workout_session_id: editWorkout.id, lift_id: newLifts[i].id});
                        else if (!prevIds.has(newLifts[i].id)) {
                            // add
                            $.post('/api/insert_lift', {sessionKey: "{{ sessionKey }}", workout_session_id: editWorkout.id, exercise_id: newLifts[i].exercise.id, lift_mass: newLifts[i].liftMass, repetitions: newLifts[i].repetitions});
                            console.log(`New lift: ${newLifts[i].id}`);
                            console.log({sessionKey: "{{ sessionKey }}", workout_session_id: editWorkout.id, exercise_id: newLifts[i].exercise.id, liftMass: newLifts[i].liftMass, repetitions: newLifts[i].repetitions});
                        } else {
                            // update
                            $.post('/api/update_lift', {sessionKey: "{{ sessionKey }}", workout_session_id: editWorkout.id, lift_id: newLifts[i].id, new_exercise_id: newLifts[i].exercise.id, new_lift_mass: newLifts[i].liftMass, new_repetitions: newLifts[i].repetitions});
                        }
                    }

                    $.post('/api/update_workout', {
                        sessionKey: "{{ sessionKey }}",
                        workout_session_id: editWorkout.id,
                        new_title: title === '' ? '[이름없는 운동]' : title,
                        new_duration: editWorkout.duration
                    }, function (response) {
                        try {
                            if (response.success) {
                                fullResetClick();
                                location.reload();
                            }
                        } catch (e) {
                            console.log(e);
                        }
                    });
                    // todo post update workout
                }
            } else {
                alert('You need to add at least one exercise for one workout session!');
            }
        }

        function fullResetClick() {
            message_broadcast({action: 'workout', value: null});
            message_broadcast({action: 'lifts', value: []});
            message_broadcast({action: 'stopwatchData', value: {hours: 0, minutes: 0, seconds: 0}});
        }

        function optionsClick(img, workoutId) {
            // set location and size
            let r = img.parentElement.getBoundingClientRect();
            let o = $('#optionsDiv');
            o.width(r.width - 30);
            o.css({left: r.left + 15, top: r.top + 15});

            // set listeners
            for (let i = 0; i < allWorkouts.length; i++)
                if (allWorkouts[i].id === workoutId) {
                    let editButton = $('#optionsDiv a:first-child');
                    let deleteButton = $('#optionsDiv a:last-child');
                    editButton.unbind();
                    deleteButton.unbind();
                    editButton.click(function () {
                        message_broadcast({action: 'workout', value: allWorkouts[i]});
                        location.reload();
                    });
                    deleteButton.click(function () {
                        $('#deleteAlertDivRoot').fadeIn(100);
                        let agreeButton = $('#deleteAlertDiv div a:last-child');
                        agreeButton.unbind();
                        agreeButton.click(function () {
                            $.post('/api/remove_workout', {sessionKey: "{{ sessionKey }}", workout_session_id: allWorkouts[i].id}, function (res) {
                                if (res.success) {
                                    location.reload();
                                } else
                                    alert('Failed to remove, please try again later!');
                            });
                        });
                    });
                }

            // display options
            $('#optionsDivRoot').fadeIn(100);
        }

        function displayTodayWorkouts(ts, workouts) {
            let date = new Date(ts);

            let rootDiv = $('#today_workouts');
            rootDiv.empty();
            rootDiv.append(`<h4 style="color: #5F36C4; font-size: 18px"><b>${date.getFullYear()}.${date.getMonth() + 1}.${date.getDate()}. ${weekdayNames[date.getDay()]}</b></h4>`);
            let kgMode = $('#weight_th').html().toLowerCase() === 'kg';
            workouts.sort((l, r) => l.timestamp < r.timestamp);
            for (let i = 0; i < workouts.length; i++) {
                rootDiv.append(`<div class="sub_content" ></div>`);
                let subDiv = $('#today_workouts .sub_content:last');
                subDiv.append(`<div style="height: 12px; display: flex; align-content: center; justify-content: space-between;">
                    <div>
                        <span style="color: #5F36C4; font-weight: bold;" class="w3-left">${workouts[i].title}</span>
                        <img onclick="favoriteWorkoutsClick(this, ${workouts[i].id});" style="margin-left: 8px; vertical-align: middle; cursor: pointer;" src="${workouts[i].isFavorite ? '{% static 'favorite-filled.png' %}' : '{% static 'favorite-outlined.png' %}'}" width="22px" height="22px">
                    </div>
                    <img onclick="optionsClick(this, ${workouts[i].id});" style="margin-left: 8px; vertical-align: middle; cursor: pointer;" src="{% static 'options.png' %}" width="22px" height="22px">
                </div>`);
                subDiv.append('<hr style="border: 1px solid lightgrey;">');
                subDiv.append('<div style="display: inline-block; padding: 8px; font-size: small; line-height: 1;"></div>');
                let liftsDiv = $('#today_workouts .sub_content:last div:last');
                for (let j = 0; j < workouts[i].lifts.length; j++) {
                    liftsDiv.append(`<span>${j + 1}. </span>`);
                    liftsDiv.append(`<span>${workouts[i].lifts[j].exercise_name}, </span>`);
                    if (kgMode)
                        liftsDiv.append(`<span>${workouts[i].lifts[j].lift_mass} KG, </span>`);
                    else
                        liftsDiv.append(`<span>${Math.trunc(workouts[i].lifts[j].lift_mass * KG2LBS * 10) / 10} LBS, </span>`);
                    liftsDiv.append(`<span>${workouts[i].lifts[j].repetitions} REPS, </span>`);
                    if (kgMode)
                        liftsDiv.append(`<span>${workouts[i].lifts[j].one_rep_max} RM </span>`);
                    else
                        liftsDiv.append(`<span>${Math.trunc((workouts[i].lifts[j].lift_mass * KG2LBS + workouts[i].lifts[j].lift_mass * KG2LBS * workouts[i].lifts[j].repetitions * ONE_REP_MAX_CONST) * 100) / 100} RM </span>`);
                    liftsDiv.append('<br><br>');
                }

                let seconds = workouts[i].duration % 60
                let minutes = (Math.trunc(workouts[i].duration - seconds) / 60) % 60;
                let hours = Math.trunc(((Math.trunc((workouts[i].duration - seconds) / 60)) % 60 - minutes) / 60)
                subDiv.append(`<div style="padding: 8px; text-align: center;" class="repeatButton">
                        <span style="font-weight: bold; font-size: large; color: #5F36C4;">
                            ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}
                        </span> <br>
                        <a onclick="repeatWorkoutSession(${workouts[i].id});" class="darkBlueBackground" style="padding: 8px 36px; border-radius: 18px; display: block; margin-top: 10px; color:white; cursor: pointer;">반복하기</a>
                    </div>`);
            }
        }

        function fetchTodayDayWorkouts(fromTs, tillTs) {
            $.post('/api/fetch_workouts', {sessionKey: "{{ sessionKey }}", fromTimestampMs: fromTs, tillTimestampMs: tillTs}).done((res) => res.success ? displayTodayWorkouts(fromTs, res.workouts) : null);
        }

        function displayWorkoutForEditing(workout) {
            $('#fullResetButton').show();

            $('#stopwatchControls').hide();
            $('#removeExercisesButton').hide();
            $('#loadFavoriteWorkoutDiv').hide();

            $('#workoutDate').html(workout.dayStr);
            $('#workoutTitle').val(workout.title);

            let seconds = workout.duration % 60;
            let minutes = ((workout.duration - seconds) / 60) % 60;
            let hours = (((workout.duration - seconds) / 60) - minutes) / 60;
            $('#exerciseDurationDisplay').html(pad(hours, 2) + ':' + pad(minutes, 2) + ':' + pad(seconds, 2));
            $('#exerciseDuration').attr('value', workout.duration.toString());

            let lifts = [];
            console.log(workout.lifts);
            for (let i = 0; i < workout.lifts.length; i++)
                lifts.push({
                    id: workout.lifts[i].id,
                    exercise: findExerciseByName(workout.lifts[i].exerciseName),
                    liftMass: workout.lifts[i].liftMass,
                    repetitions: workout.lifts[i].repetitions,
                    enabled: true,
                    rmMax: workout.lifts[i].rmMax
                });
            lifts.sort((l, r) => l.id > r.id);
            newLifts = lifts;
            setNewLiftsOnUI(lifts);
        }

        function clearWorkoutDetails() {
            $('#fullResetButton').hide();
            $('#stopwatchControls').show();
            $('#removeExercisesButton').show();
            $('#loadFavoriteWorkoutDiv').show();

            $('#workoutDate').html('{% now "Y. m. d" %} {% now "D" %}');
            $('#workoutTitle').val("");
        }
    </script>
{% endblock %}
